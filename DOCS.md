# Auth Package Reference

Comprehensive guide for **interface-based OTP email authentication with JWT tokens** in Go. Write code against `auth.Store` and `auth.Mailer` interfaces and swap backends freely.

## Architecture

```
auth (root)          — structs, interfaces, JWT helpers, errors
auth/postgres        — PostgreSQL implementation of Store
auth/zeptomail       — ZeptoMail implementation of Mailer
auth/server          — Fiber HTTP server (ready-to-run)
auth/example         — programmatic usage example
```

## Core Types

### User

Represents an authenticated user. Created automatically on first OTP verification.

```go
type User struct {
    ID        string    `json:"id"`         // UUID, auto-generated
    Email     string    `json:"email"`      // unique email address
    CreatedAt time.Time `json:"created_at"` // set by database
}
```

### OTP

Represents a one-time password. Generated by `CreateOTP`, validated by `VerifyOTP`.

```go
type OTP struct {
    ID        string    `json:"id"`         // UUID, auto-generated
    Email     string    `json:"email"`      // recipient email
    Code      string    `json:"code"`       // numeric code (default 6 digits)
    ExpiresAt time.Time `json:"expires_at"` // expiration timestamp
    Verified  bool      `json:"verified"`   // true after successful verification
    CreatedAt time.Time `json:"created_at"` // creation timestamp
}
```

### TokenPair

Returned after successful OTP verification or token refresh.

```go
type TokenPair struct {
    AccessToken  string `json:"access_token"`  // short-lived JWT (default 15 min)
    RefreshToken string `json:"refresh_token"` // long-lived JWT (default 7 days)
}
```

### Claims

Decoded JWT payload returned by `ValidateToken`.

```go
type Claims struct {
    UserID string `json:"user_id"` // user's UUID
    Email  string `json:"email"`   // user's email
    Type   string `json:"type"`    // "access" or "refresh"
}
```

### Config

Controls OTP generation, expiry durations, and JWT signing.

```go
type Config struct {
    JWTSecret     string        // HMAC-SHA256 signing key
    OTPLength     int           // digits in OTP code (default: 6)
    OTPExpiry     time.Duration // OTP validity window (default: 5m)
    AccessExpiry  time.Duration // access token lifetime (default: 15m)
    RefreshExpiry time.Duration // refresh token lifetime (default: 7d)
}
```

Use `auth.DefaultConfig(jwtSecret)` for sensible defaults, then override fields as needed.

## Store Interface

Database persistence layer. The `postgres` subpackage provides a production-ready implementation.

```go
type Store interface {
    // Schema management
    CreateSchema(ctx context.Context) error
    DropSchema(ctx context.Context) error

    // OTP operations
    CreateOTP(ctx context.Context, email string) (*OTP, error)
    VerifyOTP(ctx context.Context, email string, code string) (*User, error)

    // User lookups
    GetUserByID(ctx context.Context, id string) (*User, error)
    GetUserByEmail(ctx context.Context, email string) (*User, error)
}
```

### Method Details

#### CreateSchema

Creates `auth_users` and `auth_otps` tables with indexes. Uses `IF NOT EXISTS` — safe to call repeatedly.

#### DropSchema

Drops both tables with `CASCADE`. Destructive — use only for testing or reset.

#### CreateOTP

1. Generates a cryptographically random numeric code (length from `Config.OTPLength`)
2. Stores it in `auth_otps` with expiry from `Config.OTPExpiry`
3. Returns the full `*OTP` including the code (caller sends it via `Mailer`)

#### VerifyOTP

1. Finds the latest unverified OTP for the given email
2. Returns `ErrOTPInvalid` if no OTP exists or code doesn't match
3. Returns `ErrOTPExpired` if the OTP has passed its expiry time
4. Marks the OTP as verified
5. Finds the user by email, or **creates a new user** if none exists (auto-signup)
6. Returns the `*User`

#### GetUserByID / GetUserByEmail

Returns `*User` if found, `nil, nil` if not found, or an error on database failure.

## Mailer Interface

Email delivery layer. The `zeptomail` subpackage provides a ZeptoMail implementation.

```go
type Mailer interface {
    SendOTP(ctx context.Context, email string, code string, expiresIn time.Duration) error
}
```

### SendOTP

Sends a branded HTML email containing the OTP code to the recipient. The `expiresIn` duration is displayed in the email body (e.g., "This code expires in 5 minutes").

To use a different email provider (SendGrid, AWS SES, SMTP, etc.), implement this single-method interface.

## JWT Helpers

### GenerateTokenPair

```go
func GenerateTokenPair(cfg Config, user *User) (*TokenPair, error)
```

Creates two HMAC-SHA256 signed JWTs:
- **Access token**: contains `user_id`, `email`, `type: "access"`, expires per `Config.AccessExpiry`
- **Refresh token**: contains `user_id`, `email`, `type: "refresh"`, expires per `Config.RefreshExpiry`

### ValidateToken

```go
func ValidateToken(cfg Config, tokenStr string) (*Claims, error)
```

Parses and validates a JWT. Returns `*Claims` with `UserID`, `Email`, and `Type`. Returns an error if the token is expired, malformed, or signed with a different key.

## Sentinel Errors

```go
var ErrOTPExpired   = errors.New("auth: otp has expired")
var ErrOTPInvalid   = errors.New("auth: invalid otp code")
var ErrUserNotFound = errors.New("auth: user not found")
```

Use `errors.Is()` for matching:

```go
user, err := store.VerifyOTP(ctx, email, code)
if errors.Is(err, auth.ErrOTPExpired) {
    // handle expired OTP
}
```

## PostgreSQL Implementation

### Constructor

```go
import "github.com/meikuraledutech/auth/postgres"

store := postgres.New(pool, cfg) // pool is *pgxpool.Pool, cfg is auth.Config
```

### Database Schema

```sql
CREATE TABLE auth_users (
    id         TEXT PRIMARY KEY,
    email      TEXT NOT NULL UNIQUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE auth_otps (
    id         TEXT PRIMARY KEY,
    email      TEXT NOT NULL,
    code       TEXT NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    verified   BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

Indexes on `auth_otps(email)` and `auth_users(email)` for fast lookups.

## ZeptoMail Implementation

### Constructor

```go
import "github.com/meikuraledutech/auth/zeptomail"

mailer := zeptomail.New(apiKey, fromEmail)
```

- `apiKey`: ZeptoMail API key (the part after `Zoho-enczapikey`)
- `fromEmail`: sender address (e.g., `noreply@smart-forms.in`)

Sends a branded HTML email with the OTP code prominently displayed, expiry notice, and footer branding.

## HTTP Server Endpoints

The `server/` package provides a Fiber v3 HTTP server with these endpoints:

| Method | Path | Request Body | Response |
|--------|------|-------------|----------|
| POST | `/schema` | — | `{"message": "schema created"}` |
| POST | `/otp` | `{"email": "..."}` | `{"message": "otp sent to ...", "expires_at": "..."}` |
| POST | `/verify` | `{"email": "...", "code": "..."}` | `{"access_token", "refresh_token", "user"}` |
| POST | `/refresh` | `{"refresh_token": "..."}` | `{"access_token", "refresh_token"}` |
| GET | `/me` | Header: `Authorization: Bearer <token>` | `{"id", "email", "created_at"}` |

### Error Responses

| Status | Meaning |
|--------|---------|
| 400 | Missing or invalid request body |
| 401 | Invalid/expired OTP, invalid/expired token |
| 404 | User not found |
| 500 | Database or email delivery error |

## Authentication Flow

```
1. Client → POST /otp {"email": "user@example.com"}
   Server → generates OTP, sends email, returns confirmation

2. User checks email, gets 6-digit code

3. Client → POST /verify {"email": "user@example.com", "code": "123456"}
   Server → verifies OTP, creates user if new, returns JWT tokens

4. Client → GET /me (Authorization: Bearer <access_token>)
   Server → returns user profile

5. When access token expires:
   Client → POST /refresh {"refresh_token": "<refresh_token>"}
   Server → returns new token pair
```

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | Yes | — | PostgreSQL connection string |
| `JWT_SECRET` | Yes | — | HMAC-SHA256 signing key for JWTs |
| `ZEPTO_API_KEY` | Yes | — | ZeptoMail API key |
| `FROM_EMAIL` | No | `noreply@smart-forms.in` | Sender email address |
